#!/usr/bin/make -f

export PYBUILD_DISABLE=1
jobs := $(shell echo $$DEB_BUILD_OPTIONS | sed -r "s/.*parallel=([0-9]+).*/-j\1/")

override_dh_auto_configure:

override_dh_auto_build:

override_dh_auto_clean:

override_dh_install:
	dh_install
	install -d $(CURDIR)/debian/scylla-server/usr/bin
	for bin in debian/scylla-server/opt/scylladb/libexec/*; do debian/adjust_bin $(CURDIR)/debian/scylla-server "$${bin#*libexec/}"; done
	ln -sf /opt/scylladb/bin/scylla $(CURDIR)/debian/scylla-server/usr/bin/scylla
	ln -sf /opt/scylladb/bin/iotune $(CURDIR)/debian/scylla-server/usr/bin/iotune
	ln -sf /usr/lib/scylla/scyllatop/scyllatop.py $(CURDIR)/debian/scylla-server/usr/bin/scyllatop
	find ./dist/common/scripts -type f -exec ./relocate_python_scripts.py \
	--installroot $(CURDIR)/debian/scylla-server/usr/lib/scylla/ --with-python3 "$(CURDIR)/debian/scylla-server/opt/scylladb/python3/bin/python3" {} +
	./relocate_python_scripts.py \
	--installroot $(CURDIR)/debian/scylla-server/usr/lib/scylla/ --with-python3 "$(CURDIR)/debian/scylla-server/opt/scylladb/python3/bin/python3" \
	seastar/scripts/perftune.py seastar/scripts/seastar-addr2line seastar/scripts/perftune.py
	./relocate_python_scripts.py \
	--installroot $(CURDIR)/debian/scylla-server/usr/lib/scylla/scyllatop/ --with-python3 "$(CURDIR)/debian/scylla-server/opt/scylladb/python3/bin/python3" \
	tools/scyllatop/scyllatop.py

override_dh_installinit:
{{#scylla}}
	dh_installinit --no-start
{{/scylla}}
{{^scylla}}
	dh_installinit --no-start --name scylla-server
{{/scylla}}
	dh_installinit --no-start --name scylla-housekeeping-daily
	dh_installinit --no-start --name scylla-housekeeping-restart
	dh_installinit --no-start --name scylla-fstrim
	dh_installinit --no-start --name node-exporter

override_dh_strip:
	# The binaries (ethtool...patchelf) don't pass dh_strip after going through patchelf. Since they are
	# already stripped, nothing is lost if we exclude them, so that's what we do.
	dh_strip -Xlibprotobuf.so.15 -Xld.so -Xethtool -Xgawk -Xgzip -Xhwloc-calc -Xhwloc-distrib -Xifconfig -Xlscpu -Xnetstat -Xpatchelf --dbg-package={{product}}-server-dbg

override_dh_makeshlibs:

override_dh_shlibdeps:

override_dh_fixperms:
	dh_fixperms
	chmod 755 $(CURDIR)/debian/{{product}}-server/opt/scylladb/libreloc/ld.so

override_dh_strip_nondeterminism:

%:
	dh $@
